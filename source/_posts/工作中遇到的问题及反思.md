---
title: 工作中遇到的问题及反思
date: 2018-10-12 10:22:40
tags: [反思]
---
# 工作中碰到的问题反思及总结
感觉最近自己写的bug有点频繁，可能是大脑缺氧了吧。。。
这这里罗列出几个比较严重的问题及解决方案，谨记在心
同时罗列出工作中的重点、难点以及解决方案，供日后参考

# 主从数据库数据不同步
出现原因：库中数据约30万条，一次性删除约3万条数据，数据库数据开始不同步；
解决方案：切换为仅使用主库对外提供服务，从库数据全部清空后开始追回数据，历时约6个小时；
影响范围：有2个鬼崽子趁我们未发现主从数据不同步，越过抽奖校验，获取多个抽奖物品；

# 宝箱落地转化时的幽灵数据问题
出现原因：用户点击“领取”时，快速点击多次按钮，发起多次请求。代码中仅考虑事物原子性，未考虑多次请求处理问题，导致两次数据均被处理。数据库中最后记录仅有最后一次有效，但是存在幽灵数据（脏数据）
解决方案：使用redis加锁（lock），每次单独处理数据，是的第二次请求无法通过校验数据环节。
影响范围：数据审核校验时发现这些幽灵数据（脏数据），未对用户造成影响，但是对数据同步时会有影响。

# 数据库goods_id错位问题
出现原因：抽中流量卡礼包时，错将商品id传入背包表，导致写入数据却显示该礼品卡挂载商品。
解决方案：修改代码中的bug，将正确的物品id传入即可；将之前的数据写sql更新
影响范围：上线后用户反馈数据出错，排查后发现约3000条数据出错；
自我检讨：自己写的bug，阳哥帮我填上……写代码时思路清晰时首要；发现问题后，查明原因及日后预防方案，比匆匆修改错误数据更加重要

# 并行流在循环中的问题
出现原因：用for循环每次读2000条数据并收集，然后再读接下来的2000条，知道读完了退出。当数据量较多后（本次数据量4w+），会出现没有全读完提前退出循环的情况。使用串行流无问题。
		疑似推测：使用并行流会创建大量线程,造成线程池满了之类的问题,导致程序提前结束了。此处为线程池策略，线程池满后queue（默认时drop)
		相关资料：
```
https://dzone.com/articles/think-twice-using-java-8
https://www.baeldung.com/java-8-parallel-streams-custom-threadpool
```

