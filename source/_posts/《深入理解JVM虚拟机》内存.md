---
title: 《深入理解JVM虚拟机》内存
date: 2018-09-03 18:08:30
tags: JVM
---
有关《深入理解JVM虚拟机》的相关理解
可以将书中内容分为几个的知识块来学习。
内存：
	包括内存模型、内存管理、内存回收
JVM与class：
	class文件结构、类文件加载机制、字节码执行方式
多线程与并发：
	多线程、线程调度机制、线程安全
编译优化

## 内存
我们先来讨论虚拟机中的内存相关信息。在本书中，内存是占据内容的第一版面。正如作者所说，“内存管理者这堵高墙，墙外的人想进来，墙里的人想出去”。
我们通常将虚拟姐的内存划分为五块：程序计数区、虚拟机栈、本地方法去、java堆、方法区。其中虚拟机栈、本地方法栈、程序计数器为线程隔离状态，Java堆及方法区则是线程共享区。

### 程序计数器
程序计数器仅占用内存中较小的一块内容，可看为字节码的行号指示器。在概念模型中，字节码解释器通过改变计数器的值来选择接下来执行的字节码指令。
Java虚拟机多线程通过线程轮流切换后，分配CPU的执行时间完成。为了线程切换后可以恢复到正确的执行位置，因此每条线程拥有独立，互不影响的程序计数器，我们称之为“线程私有”。

### Java虚拟机栈
虚拟机栈描述的是java方法执行时的内存模型，生命周期与线程相同。每个方法执行时会创建一个栈帧，用于存放局部变量表、操作数栈、动态链接、方法出口等。方法从调用到结束，队形一个栈帧在虚拟机栈入栈到出栈的过程。

### 本地方法栈
本地方法栈描述的是虚拟机的Native方法运行时的内容从模型，与虚拟机栈类似。

### Java堆
Java Heap是J虚拟机管理内存中最大的一块，是被所有线程所共享的区域。作用为创建实例对象。（就是被new的对象都放在这里），因此也是内存回收的工作领域，别名GC堆（垃圾堆）

### 方法区
方法区存放虚拟机加载的类信息、常量、静态变量等。
运行时常量池是方法区的一部分，用于存放编译器生成的符号引用，这部分内容在类加载后进入运行时常量池。

###  对象创建、内存布局、访问定位

对象创建

1、接收到虚拟机new指令，首先检查指令参数能否定位到类的符号引用，并且检查所在类是否已被加载、解析和初始化。  
2、虚拟机为对象分配内存，需要了解“空闲列表”（Java堆不规整）以及“指针碰撞”（Java堆工整）
3、注意并发时加锁
4、将分配的内存空间初始化为零值
5、虚拟机设置对象头(类信息、哈希吗、CG年龄)
6、执行<init>方法
---
对象内存布局

对象头、实例数据、对齐填充
---
对象访问定位

使用句柄定位：划分出部分内存作为句柄池，存储对对象的句柄地址（类比数据库索引），GC时对象内存位置改变，仅仅改变句柄指针。
使用直接指针：存储地址对象，访问速度更快

### OutOfMemoryError（堆溢出、虚拟机栈及本地方法区溢出、方法区溢出、直接内存溢出）
Java堆溢出

---
虚拟机栈和本地方法栈溢出

方法区溢出

直接内存溢出


### GC（垃圾回收算法）










